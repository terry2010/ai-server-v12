# AI-Server-v12 Browser Agent 设计方案（v1）

> 本文档描述 AI-Server 客户端内置的 "Browser Agent / AI 浏览器" 能力设计，用于支持各类基于浏览器的人机协同自动化任务。

---

## 1. 使用场景与能力抽象

### 1.1 动作能力视角（业界通用 AI 浏览器能力）

从能力视角来看，一个通用 AI 浏览器 / Browser Agent，通常需要支持如下几大类“原子动作”，上层的各种业务流程（金融报表、审批流、数据上报等）都可以由这些动作组合而成。

> 后文所有业务流程示例，均可视为对这些原子动作的不同编排。

#### 一、导航与页面生命周期类

- 打开与跳转
  - 打开指定 URL（支持 `waitUntil: load / domcontentloaded / networkidle` 等模式）；
  - 在当前标签页中跳转、在新标签/新窗口中打开链接。
- 刷新与前进/后退
  - 刷新当前页面、回到上一个页面、前进到下一个页面。
- 等待页面状态
  - 等待 DOM Ready、网络空闲、特定 URL 片段匹配（如重定向完成、登录成功）。

#### 二、元素定位与结构感知

- 元素查找
  - 通过 CSS / XPath / Text 等选择器定位元素；
  - 判断元素是否存在 / 可见 / 可点击 / 禁用。
- 结构理解（可选增强）
  - 提取页面 DOM 结构摘要（例如表单字段列表、主要按钮列表）以供上层逻辑 / LLM 使用。

#### 三、元素交互（DOM 级）

- 点击与交互
  - 点击按钮 / 链接 / 单选、多选、下拉等控件；
  - 双击、右键点击、长按等。
- 输入与编辑
  - 聚焦输入框、清空原有内容、输入文本；
  - 模拟人类打字节奏（字符间随机延迟）。
- 表单操作
  - 切换 tab、展开/折叠面板、选择日期组件、选择下拉条目等。

#### 四、坐标级交互与复杂人机行为

- 坐标点击
  - 按屏幕 / 视口坐标点击（用于极端情况下无法稳定定位 selector 的控件）。
- 鼠标轨迹与拖拽
  - 沿给定路径移动鼠标（含速度 / 抖动曲线），按下 / 拖动 / 抬起；
  - 支持滑块拖动、拼图验证码拖动等复杂行为。
- 滚轮与平移
  - 模拟滚轮滚动、横向滚动、拖动滚动条。

#### 五、等待与时间控制

- 显式等待
  - 等待元素出现 / 消失；
  - 等待文本出现 / 变化；
  - 等待 URL / Title 满足特定条件。
- 超时与重试
  - 为每个动作配置超时时间；
  - 支持失败后自动重试 / 回退策略。
- 简单延时
  - 明确的 `sleep`（用于等待外部系统响应、机械臂 / 蓝牙 key 等）。

#### 六、内容提取与数据结构化

- HTML / 文本提取
  - 获取整页 HTML；
  - 提取指定元素的纯文本、属性（innerText / value / href / src...）。
- 结构化提取
  - 表格解析：把页面表格转成二维数组或字段名+值列表；
  - 列表 / 卡片提取：将重复元素（列表项 / 卡片）解析成结构化对象数组。
- 半结构化内容处理
  - 区块文本提取，用于再交给 AI 做理解 / 清洗（例如公告内容、报表说明）。

#### 七、文件下载与上传

- 下载
  - 监听浏览器下载事件，记录文件名 / 大小 / 完成状态；
  - 将文件保存到本地指定目录，并通过 ID / 路径暴露给上层系统。
- 上传
  - 在 `<input type="file">` 元素上设置本地文件；
  - 触发上传按钮，监听上传进度 / 完成状态。

#### 八、多页面 / 多窗口 / frame 管理

- 标签页 / 窗口管理
  - 创建 / 关闭专用 BrowserWindow 或 tab；
  - 在多个页面间切换、按条件找到指定任务窗口（如带有特定 hash）。
- frame / iframe 操作
  - 识别并切换不同 frame；
  - 在嵌套 frame 内定位元素和执行动作。

#### 九、截图、录屏与可视化调试

- 截图能力
  - 整页 / 视口 / 元素 / 指定区域截图；
  - 支持 JPEG/PNG 等格式、质量设置；
  - 自动给关键步骤打标签（如“登录前”“登录后”“导出完成页”）。
- 录屏（可选增强）
  - 短时录制浏览器操作过程，便于故障回放。
- 标注
  - 在截图上高亮某个元素区域（辅助人工查看）。

#### 十、浏览器环境与会话控制

- 环境配置
  - 设置 User-Agent、语言、时区、窗口大小、DPI 等；
  - 配置代理、证书策略等。
- 会话管理
  - 独立的 cookie jar / storage 区域（按 profile 隔离不同系统）；
  - 保存与载入会话（复用登录态）。
- 缓存与存储
  - 清理缓存、cookies、本地存储；
  - 查看 / 导出 cookie、localStorage、sessionStorage。

#### 十一、网络与请求拦截（可选）

- 请求拦截
  - 拦截 / 修改请求头、请求体（如加 header / trace-id）；
  - 阻止某些资源（广告脚本、大图片）以减轻负担。
- 响应观察
  - 监听后台接口返回，辅助判断业务动作是否成功；
  - 记录关键接口 payload 便于排查问题。

#### 十二、任务与审计

- 动作日志
  - 为每个动作记录时间戳、参数摘要、结果、耗时、错误信息。
- 时间线视图
  - 将一整个会话的动作序列视为时间序列，用于可视化回放和 debug。
- 异常处理与告警
  - 超时、网络错误、元素找不到等场景的统一错误模型；
  - 支持将严重错误上报到外部告警系统。

### 1.2 任务类型与约束抽象

在上述原子动作之上，可以抽象出多种任务类型和约束维度，用来描述“几百个 n8n 流程”的共性：

- 任务类型（示例）：
  - 数据采集类任务：周期性登录系统抓取数据；
  - 业务操作类任务：执行审批、提报、确认等有副作用操作；
  - 数据搬运类任务：A 系统导出 → 中间处理 → B 系统上传；
  - 辅助自动化类任务：自动把页面引导到某个状态，后续由人工接管。

- 约束维度（示例）：
  - 时间约束：每个动作超时、整体任务超时、工作时间窗口；
  - 安全约束：允许访问的域名范围、需要人工确认的高风险动作；
  - 资源约束：单客户端最大并发会话数、CPU/内存上限；
  - 可靠性约束：失败重试策略、错误告警方式等。

### 1.3 示例：典型高复杂度任务（抽象示意）

本节用于展示若干典型的高复杂度浏览器自动化任务（例如某类高安全等级业务系统的登录、数据导出与后续处理流程），不包含任何真实系统名称或敏感实现细节。通过这些抽象示意，可以对照 1.1 的动作能力和 1.2 的约束维度，说明 Browser Agent 如何支撑复杂任务编排。（内容略，后续可按需补充通用流程图与时序图。）

---

## 2. 总体架构

> 本章描述 Browser Agent 在 AI-Server 客户端中的整体位置，以及与 n8n 等外部系统的关系。具体实现细节（如 Playwright / Puppeteer / CDP）视后续选型而定，这里聚焦于角色与边界。

### 2.1 分层架构

- 编排层（Orchestrator）
  - 由 n8n 等工作流系统承担，负责任务调度、决策分支、错误重试、告警等；
  - 通过 HTTP/JSON 调用 Browser Agent 提供的动作接口。

- 浏览器动作层（Browser Agent）
  - 运行于 AI-Server 客户端进程中，只监听本机（127.0.0.1）；
  - 对上暴露有限的高层动作 API（navigate/click/fill/waitFor/...）；
  - 内部统一管理 BrowserWindow / BrowserView 以及与之绑定的 CDP/Playwright 控制逻辑。

- 浏览器运行时层（Browser Runtime）
  - 实际的浏览器渲染环境（Electron BrowserWindow + Chromium）；
  - 通过 CDP 或 Playwright-core 等方式被 Browser Agent 控制；
  - 与主 UI 窗口隔离，使用专用窗口/会话承担任务执行。

### 2.2 组件与进程关系

- Electron 主进程
  - 负责创建 / 管理 BrowserWindow；
  - 承载 Browser Agent HTTP 服务（或与之协作的模块）；
  - 暴露必要的内部 IPC 供渲染层 UI 使用（AI 浏览器标签页等）。

- Electron 渲染进程
  - 负责 AI-Server 管理 UI，包括“AI 浏览器”标签页；
  - 通过 preload 暴露的 API 调用主进程查询任务状态、日志、截图等。
  - 在“设置中心”中提供独立的「Agent 设置」标签页，用于配置 Browser Agent 的启用状态、端口、访问 token 与数据目录等参数。

- 外部系统（n8n 等）
  - 通过 HTTP/JSON 调用 Browser Agent；
  - 不直接接触 BrowserWindow / CDP / Playwright 等低层细节。

### 2.3 安全边界

- 默认情况下，Browser Agent HTTP 服务只监听本机 127.0.0.1，用于“单机桌面 + 本地自动化”场景，对外网不可见；
- 在机房多客户端 + n8n 集群场景下，可通过内网网关 / 反向代理将各客户端的 Agent 端口暴露到受控的内网地址，并结合 IP 白名单与访问 token 做访问控制（详细见第 7 章安全设计）；
- 所有动作都通过受控的 API 进行，不暴露原始 CDP / 任意 JS 执行接口；
- 通过 token / 配置约束调用者，避免未授权进程滥用浏览器能力。

---

## 3. 会话与生命周期管理

### 3.1 Session / Task 概念

- `sessionId`：一次浏览器会话，通常对应一个专用 BrowserWindow 或 BrowserView；
- 一个 n8n 工作流运行实例可以：
  - 绑定 1 个 session 从头到尾完成整个任务；
  - 或在一个 session 内分多次调用不同动作（一步一调模式）。

### 3.2 生命周期与超时策略

- 基本状态
  - `created` → `running` → `idle` → `completed` / `failed` / `timeout` / `aborted`。

- 生命周期配置
  - `maxSessionDuration`：单个 session 最长存活时间（如 30 分钟）；
  - `maxIdleDuration`：长时间无动作 / 无前端 attach 时自动清理（如 5 分钟）。
  - 支持为单个原子动作配置超时（`timeoutMs`）及超时后策略（`onTimeout`），例如：保持现状、自动截图后刷新页面、或直接关闭会话并上报超时。

- 超时处理流程
  - 当 session 超过 `maxSessionDuration` 或 `maxIdleDuration`：
    - 标记状态为 `timeout`；
    - 记录日志 + 截图最后页面（用于排查）；
    - 关闭对应 BrowserWindow / 释放相关资源；
    - 触发告警机制（如写入告警日志或回调 n8n 定义的 HTTP 地址，可在后续版本扩展）。

- 与后续任务的衔接
  - 超时自动清理的主要目标是在高并发 / 长时间运行场景下，确保客户端不会因为残留 session 占用资源，导致后续任务无法分配可用浏览器窗口。

---

## 4. Browser Agent HTTP API 概览

> 本章只给出 API 分类与主要能力，具体 URL、入参与响应结构可在后续细化文档中详细定义。

### 4.1 会话管理接口

- 创建会话：
  - 功能：为指定 profile 创建一个新的浏览器会话（专用 BrowserWindow）。
  - 参数示例：profile、headful(是否可见)、viewport、userAgent 等。
- 查询会话列表 / 单个会话状态：
  - 返回当前 URL、标题、状态、最近错误、最近截图等。
- 关闭会话：
  - 主动销毁会话及其 BrowserWindow，释放资源。

### 4.2 页面导航与等待

- 导航：
  - 打开指定 URL，支持多种 waitUntil 模式及超时控制；
  - 可选记录导航耗时与关键指标。
- 页面状态查询：
  - 返回 `url` / `title` / `readyState` 等简单状态信息。
- 条件等待：
  - 等待 selector 出现 / 文本出现 / URL 包含某子串等。

### 4.3 DOM 级交互

- DOM 点击：
  - 根据 selector 执行点击，支持按钮类型、点击次数等参数。
- DOM 填写：
  - 对输入框进行聚焦、清空、输入文本等操作。
- DOM 滚动：
  - 将元素滚动到可视区域；
  - 或按一定步长滚动页面。
- 文件上传：
  - 在 `<input type=file>` 上设置本地文件（基于 fileId 或绝对路径）；
  - 触发上传按钮并可选监听完成状态。

### 4.4 坐标级交互

- 坐标点击：
  - 在指定 `(x, y)` 坐标处模拟鼠标点击，支持按钮类型与点击次数。
- 鼠标移动：
  - 将鼠标分若干步移动到指定坐标，用于模拟人类行为。
- 鼠标拖动（路径）：
  - 沿一组 `{ x, y, tMs }` 轨迹执行按下、移动、抬起，用于滑块等复杂验证码场景。

### 4.5 等待与时间控制

- 显式等待接口：
  - 等待元素出现 / 消失；
  - 等待文本 / URL 条件；
  - 支持超时与错误返回。
- 延时接口：
  - 简单 `sleep`，用于等待外部系统（如机械臂 / 蓝牙 key）完成操作。

### 4.6 截图与快照

- 截图：
  - 整页 / 视口 / 元素 / 指定区域截图，返回文件 ID 或 Base64；
  - 可附带描述信息以便在任务时间线中标记（如“登录前验证码截图”）。
- 快照管理：
  - 列出会话的历史截图；
  - 下载 / 预览单个截图。

### 4.7 文件下载管理

- 文件列表：
  - 列出某会话产生的所有下载文件（文件名 / 大小 / 时间 / 状态）。
- 文件获取：
  - 根据 fileId 下载文件内容，用于 n8n 或其他系统后续处理 / 上传。

### 4.8 内容提取接口

- HTML 提取：
  - 返回当前页面完整 HTML，供离线分析或调试使用。
- 文本提取：
  - 基于页面整体或指定 selector 提取纯文本，支持空白折叠等选项。
- 结构化提取：
  - 表格解析为结构化数据；
  - 列表 / 卡片解析为对象数组；
  - 统一封装为 JSON 结构返回。

### 4.9 日志与时间线

- 动作日志：
  - 返回该会话的动作列表，每条包含：动作类型、入参摘要、开始时间、结束时间、耗时、结果与错误信息；
- 时间线视图：
  - 将动作日志按时间排序，形成任务执行时间线，供 UI 展示与故障排查；
- 实时事件流（可选）：
  - 使用 SSE/WebSocket 提供 `action-started` / `action-finished` / `error` 等事件，用于构建实时监控界面。

> 说明：
> - v1 版本中，上述接口以同步请求-响应模式为主（即一次调用执行一个原子动作并返回结果），复杂任务由外部 Orchestrator（如 n8n）通过多次调用组合完成；
> - 每个动作接口均支持显式超时参数（如 `timeoutMs`）与可选的超时后策略（`onTimeout`，例如记录截图后刷新页面 / 直接关闭会话），并统一通过结构化错误码返回；
> - 后续可在此基础上增加“脚本型 / 批处理”异步任务接口，并支持在创建任务时自定义 `callbackUrl` / `callbackHeaders` / 回调负载模板，任务完成或失败后由 Agent 主动回调通知结果。

---

## 5. 与 n8n 的集成方案（概览）

> 本章只做概览，详细的 n8n 自定义节点设计可在单独文档中展开。

- 调用模式：
  - **一步一调模式**：n8n 作为编排引擎，逐步调用 Browser Agent API，每一步根据结果 / 截图 / 内容决定下一步；
  - （可选）批处理模式：将一组动作作为脚本一次性下发，由 Browser Agent 内部执行。

- 自定义节点建议：
  - `Browser Agent: Create Session / Close Session`；
  - `Browser Agent: Navigate / Click / Fill / Wait / Screenshot / Download / UploadFile / ExtractContent / DragSlider` 等；
  - 节点参数与 Browser Agent HTTP API 一一对应，隐藏复杂细节（如 fileId 管理）。

- 旧流程迁移：
  - 将原有基于 `n8n-nodes-puppeteer` 的流程拆分为对 Browser Agent API 的调用；
  - 保留 n8n 现有的调度、变量管理、错误处理与机械臂 / 蓝牙 key 集成逻辑；
  - 使浏览器自动化部分从“直接控制 Chrome”迁移为“调用本机 Browser Agent 服务”。

- 实现路径建议：
  - v1：优先通过 n8n 内置的 HTTP Request / Webhook 节点与 Browser Agent 交互，快速验证整体方案可行性；
  - v2：在 Browser Agent 接口相对稳定后，封装独立的 n8n 社区节点（例如 `n8n-nodes-ai-server-browser-agent`），内置 Credential、Resource/Operation 选择器与参数表单，方便非开发人员在不写 JSON 的情况下复用这些能力。

---

## 6. 客户端内部 UI：AI 浏览器标签页

> 本章描述 AI-Server 客户端中“AI 浏览器”标签页的主要功能与布局，便于监控与调试 Browser Agent 任务。

### 6.1 总览页

- 展示信息：
  - Browser Agent 启用状态；
  - 监听端口、最大会话并发、默认超时配置等；
  - 当前运行中的 session 数量、历史任务总数等。

- 操作入口：
  - 跳转到系统设置中的「Agent 设置」配置区（`settings.browserAgent.enabled/port/token/dataRoot`）；
  - （后续可选）一键重启 Agent、清理全部空闲会话等。

### 6.2 任务列表页

- 列表字段：
  - 任务 / Session ID；
  - Profile（例如银行 / 系统名称）；
  - 状态（运行中 / 成功 / 失败 / 超时 / 已终止）；
  - 开始时间、结束时间、总耗时；
  - 最近一步动作名称 / 错误摘要。

- 过滤与搜索：
  - 按时间区间、profile、状态过滤；
  - 关键字搜索（按任务 ID / 错误信息片段）。

- 操作：
  - 点击某条记录进入任务详情页；
  - （可选）批量终止选中任务。

### 6.3 任务详情页

- 时间线视图：
  - 按时间顺序列出所有动作（navigate / click / fill / wait / screenshot / download / ...）；
  - 显示每一步的开始时间、结束时间、耗时、简要描述、结果；
  - 支持点击某一步高亮关联的截图或文件。

- 截图与快照：
  - 展示该任务产生的关键截图列表（小缩略图）；
  - 鼠标悬停预览大图，点击全屏查看；
  - 支持导出截图到本地文件系统。

- 文件区域：
  - 列出任务相关下载文件（文件名 / 大小 / 时间）；
  - 提供“打开所在文件夹”“复制路径”“下载到本机”等操作。

- 控制区域：
  - “打开任务窗口”：将对应的 BrowserWindow 显示出来，便于人工介入调试；
  - “终止任务”：向 Browser Agent 发出终止指令，关闭该 session；
  - （后续可选）“标记为人工介入”：记录任务由人工接管，并在日志 / 报表中体现。

### 6.4 调试辅助（后续规划）

- 实时日志流：
  - 基于 SSE/WebSocket 订阅某个 session 的实时事件，在 UI 中滚动显示；
- Selector 辅助工具：
  - 在“打开任务窗口”时，允许开发者在页面上点选元素，自动生成推荐 selector，辅助编写 n8n 流程；
- Trace 回放：
  - 将时间线上的动作序列回放为动画，帮助理解失败原因与时序问题。

---

## 7. 安全性与权限控制（概览）

### 7.1 威胁模型与部署形态

- 单机桌面场景：
  - AI-Server 仅在单台桌面 / 工控机上运行，Browser Agent 主要供本机的 n8n / 脚本使用；
  - 主要风险来自同一台机器上的其他进程 / 用户滥用浏览器自动化能力。

- 机房多客户端 + n8n 集群场景：
  - 机房中有若干台安装了 AI-Server 的客户端，每台都运行一个 Browser Agent 实例；
  - 中央 n8n 集群通过内网访问这些 Agent，为大量任务做统一调度；
  - 需要在网络层、鉴权层和配额层限制“谁可以从哪里、以多大速率调用哪些能力”。

### 7.2 网络与鉴权

- 网络隔离：
  - 默认情况下，仅监听本机 127.0.0.1，适用于“单机桌面 + 本地自动化”场景；
  - 在机房场景下，通过防火墙 / 安全组 / 内网网关，仅允许来自 n8n 集群所在网段的访问；
  - 如需公网访问，应强制走反向代理 + TLS 终止，并限制来源 IP 段。

- 基础鉴权：
  - 支持 IP 白名单（可配置多个网段 / 单 IP）；
  - 支持 HTTP 基础认证或 Bearer Token 方式；
  - 为每个调用方（clientId）分配独立凭证，凭证泄露时可以精确吊销。

- 进阶鉴权（可选）：
  - 在反向代理层启用 mTLS，要求调用方提供客户端证书；
  - 将证书身份映射到 Browser Agent 的 `clientId`，进一步收紧访问来源。

### 7.3 权限、配额与防滥用

- 每调用方授权配置：
  - `allowedProfiles`：允许访问的业务 profile / 系统列表；
  - `maxConcurrentSessions`：单 clientId 允许同时持有的最大会话数；
  - `rateLimit`：单位时间内的最大请求数（QPS / RPM）；
  - `maxActionsPerSession`：单个会话允许执行的最大原子动作数。

- 防滥用机制：
  - 超出配额时返回明确错误，并可选记录安全告警日志；
  - 对异常模式进行简单规则检测（如：频繁创建但不关闭 session、大量截图 / HTML 抓取、访问不在白名单的域名等）；
  - 暂时封禁异常 clientId 一段时间，或降级其可用配额。

> 说明：Browser Agent 无法“自动识别一切恶意意图”，但可以通过严格的权限边界、配额和审计，将滥用的影响范围和可疑行为控制在可观测、可追责的范围内。

### 7.4 日志、审计与数据存储

- 元数据存储（当前版本）：
  - 不引入 SQLite 等本地数据库，采用“纯文本 + JSON/NDJSON 文件 + 简单索引”的方案存储会话、动作、截图、文件的元信息：
    - `sessions.ndjson`：每行一个会话记录（`sessionId`、`profile`、`clientId`、状态、开始/结束时间等）；
    - `actions.ndjson`：每行一个动作记录（`sessionId`、`actionType`、`params`、开始/结束时间、状态、错误摘要等）；
    - `snapshots.ndjson`：截图元数据（`sessionId`、`actionId`、文件路径、时间、类型等）；
    - `files.ndjson`：下载文件元数据（`sessionId`、文件路径、大小、时间、MIME 类型等）。
  - 可以结合内存中的简易索引（例如按日期、`clientId`、`profile` 维护映射），满足 UI 中的过滤 / 搜索场景；
  - JSON 字段设计尽量靠近关系型表结构，未来如需迁移到 PgSQL / MySQL，可通过离线导入脚本将 NDJSON 数据导入数据库。

- 大文件存储建议：
  - 截图、HTML 快照、下载文件等实际内容存放在文件系统中；
  - 目录建议可配置，例如：`data/browser-agent/{date}/{sessionId}/screenshots/`；
  - JSON/NDJSON 元数据文件中仅保存路径、大小、类型、时间等信息，便于查询与清理。

- 检索与审计：
  - 提供按时间、profile、`clientId`、状态、动作类型等维度的查询能力；
  - 在需要时可对 NDJSON 文件做简单的离线索引或导入外部搜索引擎（如 ELK / ClickHouse），用于更复杂的审计分析；
  - 支持按策略导出指定时间范围内的会话 / 动作日志（基于 NDJSON 片段），用于外部审计系统接入或跨环境导入回放。

- 保留与归档策略：
  - 在系统设置中配置日志与截图的保留期限或最大占用空间；
  - 超出阈值时按时间顺序自动归档或删除最早的数据；
  - 对于合规要求较高的环境，可周期性将元数据与关键截图同步到集中日志 / 存储系统（如 ELK / ClickHouse / 对象存储等），由统一平台做长期留存与审计。

- 隐私与安全：
  - 尽量避免在日志中记录账号、密码、一次性验证码等敏感内容；
  - 数据目录可结合操作系统级磁盘加密（如 BitLocker）提高物理安全性；
  - 如需更高安全级别，可在应用层对截图 / HTML 等进行加密存储，但需同时规划好密钥管理策略。

---

## 8. 性能与并发（概览）

- 最大并发 Session 数量配置；
- 单个 Session 内动作队列与顺序执行模型；
- 资源监控（CPU / 内存）与限流策略（后续可在监控模块中扩展）。

---

## 9. 迭代规划

- v1：
  - 实现支持关键业务场景（如金融网页示例）的最小动作集与 API；
  - 提供基础的 AI 浏览器 UI（任务列表 + 简单详情 + 截图）。

- v2 及以后：
  - 增强内容提取与结构化能力；
  - 增加 Trace 回放、Selector 辅助等开发者工具；
  - 探索与 LLM Agent 的集成，在同一套 Browser Agent API 上支持“智能体式”自动化。
